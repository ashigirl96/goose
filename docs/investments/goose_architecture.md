# goose architecture communication desktop backend
# デスクトップクライアントからGooseバックエンドへの通信の仕組み

## 全体アーキテクチャ

1. **デスクトップアプリケーション**: Electron（Node.js + Chromium）で実装されたUIクライアント
2. **バックエンドサーバー**: `goosed` という名前の、Rustで実装されたHTTPサーバー

## 通信の流れ

### 1. サーバーの起動プロセス

1. デスクトップアプリが起動すると、サブプロセスとして `goosed` サーバーを起動
   - `startGoosed` 関数（`ui/desktop/src/goosed.ts`）で実行
   - 利用可能なポートを自動検出（`findAvailablePort`関数）
   - ランダムな秘密鍵を生成（セキュリティのため）
   - サーバープロセスはデスクトップアプリが閉じられると自動的に終了

2. デスクトップアプリはサーバーの準備ができるまで待機
   - `checkServerStatus`関数でサーバーの起動を確認
   - ポーリングによるステータスチェック

### 2. API通信の設定

1. サーバーの情報（ポート、秘密鍵など）がレンダラープロセスに渡される
   - `preload.ts`を通じて、ElectronのIPC（プロセス間通信）で設定を渡す
   - `appConfig` オブジェクトとしてブラウザウィンドウから利用可能にする

2. APIクライアントの初期化
   - `config.ts`の`getApiUrl`関数で、エンドポイントURLを構築
   - `getSecretKey`関数で秘密鍵を取得
   - 各API呼び出しでは`X-Secret-Key`ヘッダーで認証

### 3. メッセージのやり取り

1. ユーザーがメッセージを送信すると、`useMessageStream`フック（`hooks/useMessageStream.ts`）がAPIリクエストを処理
   - `/reply`エンドポイントにPOSTリクエストを送信
   - メッセージ履歴とセッション情報をJSONとして送信

2. サーバーからのレスポンス処理
   - サーバー応答はSSE（Server-Sent Events）形式のストリームとして受信
   - イベントタイプ：`Message`（新メッセージ）、`Error`（エラー情報）、`Finish`（終了通知）

3. レスポンスの表示
   - 受信したメッセージはUI（`ChatView.tsx`）で表示
   - ツールの呼び出しや確認が必要な場合はUIで対応するコンポーネントを表示

## 技術詳細

### サーバーサイド（Rust）
- Axumフレームワークを使用したHTTPサーバー
- CORS対応によるクロスオリジン通信の許可
- エンドポイント：
  - `/reply`: メインのメッセージ応答（SSEストリーミング）
  - `/ask`: シンプルなAI応答（非ストリーミング）
  - `/confirm`: ツール確認リクエストの処理

### クライアントサイド（TypeScript/React）
- Fetchベースのリクエスト処理
- SSEストリームをリアルタイムで処理
- Reactのフックを活用したステート管理

### セキュリティ
- 起動時に生成されるランダムな秘密鍵で認証
- ローカルホスト上の通信のみ（外部接続は不可）

