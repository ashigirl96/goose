# Gooseのセッションモジュール解析

`crates/goose-cli/src/session/mod.rs`ファイルは、Gooseの対話型セッション管理を担当する中心的なモジュールです。このドキュメントでは、その機能と役割を詳細に解説します。

## 基本構造

このモジュールは、以下のサブモジュールをインポートして機能を実装しています：

- `builder`: セッションの構築と初期化
- `completion`: コマンド補完機能
- `input`: ユーザー入力の処理
- `output`: 出力表示と整形
- `prompt`: プロンプト関連の機能
- `thinking`: 思考表示機能（AIが考えている間の表示）

## 主要コンポーネント

### Session構造体

```rust
pub struct Session {
    agent: Box<dyn Agent>,           // AIエージェント
    messages: Vec<Message>,          // メッセージ履歴
    session_file: PathBuf,           // セッションファイルへのパス
    completion_cache: Arc<std::sync::RwLock<CompletionCache>>, // 補完用キャッシュ
    debug: bool,                     // デバッグモードフラグ
    run_mode: RunMode,               // 実行モード (Normal/Plan)
}
```

### 実行モード

```rust
pub enum RunMode {
    Normal,  // 通常の対話モード
    Plan,    // 計画モード
}
```

### CompletionCache構造体

コマンド補完のキャッシュを管理します：

```rust
struct CompletionCache {
    prompts: HashMap<String, Vec<String>>,
    prompt_info: HashMap<String, output::PromptInfo>,
    last_updated: Instant,
}
```

## 主要機能

### セッション管理

1. **セッション初期化**：
   - 既存のセッションファイルからメッセージを読み込む
   - 新規セッションを作成
   - デバッグモードの設定

2. **拡張機能管理**：
   - `add_extension`: 外部（stdio）拡張機能の追加
   - `add_builtin`: 組み込み拡張機能の追加

3. **プロンプト管理**：
   - `list_prompts`: 利用可能なプロンプトの一覧表示
   - `get_prompt_info`: 特定のプロンプトの詳細情報取得
   - `get_prompt`: プロンプトのメッセージ取得

### 対話処理

1. **メッセージ処理**：
   - `process_message`: 単一メッセージの処理と応答取得
   - `process_agent_response`: エージェントからの応答処理

2. **インタラクティブセッション**：
   - `interactive`: 対話式セッションの実行
   - 入力取得、応答処理、履歴管理を担当
   - コマンド履歴の永続化

3. **非対話モード**：
   - `headless`: 単一メッセージ処理と終了

### プランニングモード

1. **計画生成**：
   - `plan_with_reasoner_model`: 別のAIモデル（リーズナー）を使用した計画生成
   - `classify_planner_response`: 計画かそれとも質問かの判別

2. **計画実行**：
   - ユーザーの確認後、計画に基づいてアクションを実行
   - 必要に応じて設定を一時的に変更

### 例外処理

1. **割り込み処理**：
   - `handle_interrupted_messages`: ツール実行中の中断処理
   - Ctrl+Cによる割り込みへの対応
   - エラー発生時のリカバリ

2. **メッセージ永続化**：
   - セッションファイルへのメッセージ保存
   - 割り込み後の状態復帰

### コマンド補完

1. **補完キャッシュ**：
   - `update_completion_cache`: 補完データの更新
   - `invalidate_completion_cache`: キャッシュの無効化

2. **カスタム補完**：
   - `GooseCompleter`: カスタム補完ヘルパー
   - コンテキスト対応の補完機能

## セッションフロー

典型的なセッションフローは以下の通りです：

1. セッション初期化（既存ファイルからの読み込みまたは新規作成）
2. インタラクティブループ開始
3. ユーザー入力の取得と解析
4. 入力タイプに応じた処理：
   - メッセージ：AIエージェントに送信して応答を処理
   - コマンド：拡張機能追加、テーマ切り替えなどの操作
   - プロンプト：特定のプロンプトの実行
   - プランニング：計画モードでの対話
5. 結果の表示と履歴の更新
6. ループ継続（終了コマンドまで）

## 特筆すべき設計ポイント

1. **モジュラー設計**：
   - 機能ごとに分離されたサブモジュール
   - 関心の分離による保守性の向上

2. **拡張性**：
   - 動的な拡張機能の追加サポート
   - プラグイン的なアーキテクチャ

3. **エラー耐性**：
   - 例外的な状況への対応
   - 割り込み処理とリカバリ機能

4. **状態永続化**：
   - メッセージ履歴の保存と復元
   - コマンド履歴のグローバル管理

5. **ユーザーエクスペリエンス**：
   - カスタマイズ可能なテーマ
   - コマンド補完機能
   - 「考え中」表示

6. **マルチモードサポート**：
   - 通常対話モードとプランニングモード
   - ヘッドレスモード（非対話）

以上の分析から、`session/mod.rs`はGooseの対話型インターフェースの中心的なコンポーネントであり、ユーザー入力の処理からAIエージェントとの通信、結果の表示、そして状態管理までを担当していることがわかります。また、拡張性と堅牢性を考慮した設計により、様々な使用シナリオに対応できる柔軟な構造となっています。